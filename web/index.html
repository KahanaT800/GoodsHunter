<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoodsHunter</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>
  <body>
    <div id="app">
      <header>
        <div class="logo">{{ t('common.appName') }}</div>
        <div class="header-right">
          <select class="lang-select" v-model="lang" @change="setLang">
            <option value="zh">中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
          </select>
          <div class="user-meta">
            <div class="user-email">{{ userEmail || t('common.notLoggedIn') }}</div>
            <span v-if="isGuest" class="visitor-badge">{{ t('common.visitorMode') }}</span>
          </div>
          <button class="user-btn" @click="showAuth = true">{{ userBadge }}</button>
        </div>
      </header>

      <div v-if="!token" class="auth-mask">
        <div class="auth-panel">
          <div class="auth-tabs">
            <button class="auth-tab" :class="{ active: authTab === 'login' }" @click="authTab = 'login'">
              {{ t('auth.login') }}
            </button>
            <button class="auth-tab" :class="{ active: authTab === 'register' }" @click="authTab = 'register'">
              {{ t('auth.register') }}
            </button>
          </div>

          <div v-if="authTab === 'login'" class="auth-body">
            <label>{{ t('auth.email') }}</label>
            <input v-model="authForm.email" placeholder="user@example.com" />
            <label>{{ t('auth.password') }}</label>
            <input type="password" v-model="authForm.password" />
            <div class="muted">{{ t('auth.passwordHint') }}</div>
            <button class="btn-primary" @click="login" :disabled="loading.auth">{{ t('auth.login') }}</button>
          </div>

          <div v-else class="auth-body">
            <label>{{ t('auth.email') }}</label>
            <input v-model="authForm.email" placeholder="user@example.com" />
            <label>{{ t('auth.password') }}</label>
            <input type="password" v-model="authForm.password" />
            <div class="muted">{{ t('auth.passwordHint') }}</div>
            <label>{{ t('auth.inviteCode') }}</label>
            <input v-model="authForm.invite_code" :placeholder="t('auth.inviteCode')" />
            <button class="btn-primary" @click="register" :disabled="loading.auth">{{ t('auth.registerSend') }}</button>
            <label style="margin-top: 12px;">{{ t('auth.verifyCode') }}</label>
            <input v-model="verifyCode" :placeholder="t('auth.verifyCode')" />
            <button class="btn-outline" @click="verifyEmail" :disabled="loading.auth">{{ t('auth.verify') }}</button>
            <button class="btn-outline" style="margin-top:8px;" @click="resendCode" :disabled="loading.auth || resendCountdown > 0">
              {{ resendCountdown > 0 ? t('auth.resendCountdown', { seconds: resendCountdown }) : t('auth.resend') }}
            </button>
          </div>

          <button class="guest-btn" @click="guestLogin" :disabled="loading.auth">{{ t('auth.guest') }}</button>
        </div>
      </div>
      <div class="container">
        <div class="panel">
        <h2>{{ t('task.manage') }}</h2>
        <div>
          <label>{{ t('task.keyword') }}</label>
          <input v-model="form.keyword" :placeholder="t('task.keywordPlaceholder')" />
          <label>{{ t('task.platform') }}</label>
          <select v-model.number="form.platform">
            <option :value="1">Mercari</option>
          </select>
          <label>{{ t('task.minPrice') }}</label>
          <input type="number" v-model.number="form.min_price" />
          <label>{{ t('task.maxPrice') }}</label>
          <input type="number" v-model.number="form.max_price" />
          <label>{{ t('task.sort') }}</label>
          <select v-model="form.sort">
            <option value="created_time|desc">{{ t('task.sortNewest') }}</option>
            <option value="price|asc">{{ t('task.sortPriceAsc') }}</option>
            <option value="price|desc">{{ t('task.sortPriceDesc') }}</option>
          </select>
              <button class="btn-primary" @click="createTask" :disabled="loading.create || tasks.length >= maxTasksPerUser">
                {{ loading.create ? t('task.creating') : t('task.create') }}
              </button>
        </div>
        <div style="margin-top:16px;">
          <h2>{{ t('task.list') }}</h2>
          <div v-if="tasks.length === 0" class="muted">{{ t('task.empty') }}</div>
          <div
            v-for="task in tasks"
            :key="task.id"
            class="task-card"
            :class="{ selected: task.id === selectedTaskId }"
            @click="selectTask(task)"
          >
            <div class="task-header">
              <div>
                <div><strong>{{ task.keyword }}</strong></div>
                <div class="muted">{{ priceRange(task) }}</div>
              </div>
              <div class="status" :class="task.status">{{ task.status }}</div>
            </div>
            <div class="actions">
              <div class="notify-toggle" @click.stop>
                <span class="toggle-label">{{ t('task.notify') }}</span>
                <label class="switch">
                  <input type="checkbox" :checked="task.notify_enabled" @change="toggleNotify(task)" />
                  <span class="slider"></span>
                </label>
              </div>
              <button class="btn-outline" @click.stop="startEditTask(task)" :disabled="loading.edit">
                {{ t('task.edit') }}
              </button>
              <button class="btn-outline" @click.stop="toggleTask(task)" :disabled="loading.toggle">
                {{ task.status === 'running' ? t('task.stop') : t('task.start') }}
              </button>
              <button class="btn-danger" @click.stop="deleteTask(task)" :disabled="loading.delete">{{ t('task.delete') }}</button>
            </div>
            <div v-if="editingTaskId === task.id" class="task-edit" @click.stop>
              <div class="muted" style="margin-bottom:6px;">{{ t('task.adjustPrice') }}</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="number" v-model.number="editForm.min_price" :placeholder="t('task.minPriceShort')" style="width:120px;" />
                <span class="muted">-</span>
                <input type="number" v-model.number="editForm.max_price" :placeholder="t('task.maxPriceShort')" style="width:120px;" />
                <button class="btn-primary" @click.stop="saveEditTask(task)" :disabled="loading.edit">{{ t('task.save') }}</button>
                <button class="btn-outline" @click.stop="cancelEditTask">{{ t('task.cancel') }}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h2>{{ t('items.title') }}</h2>
        <div v-if="!selectedTaskId" class="muted">{{ t('items.selectTask') }}</div>
        <div v-else-if="items.length === 0" class="muted">
          <span v-if="timelineStatus === 'no_items'">{{ t('items.noItems') }}</span>
          <span v-else-if="timelineStatus === 'failed'">{{ t('items.failed') }}</span>
          <span v-else>{{ t('items.empty') }}</span>
          <br/>
          <small v-if="timelineMessage" style="font-size: 11px; opacity: 0.7;">{{ timelineMessage }}</small>
          <small v-else style="font-size: 11px; opacity: 0.7;">{{ t('items.startHint') }}</small>
        </div>
        <div v-else class="timeline">
          <div class="item-card" v-for="item in items" :key="item.id">
            <img :src="item.image_url || fallbackImage" :alt="item.title" />
            <div class="item-body">
              <div class="price">
                ¥{{ item.price }}
                <span v-if="isNewItem(item)" class="badge-new">{{ t('items.new') }}</span>
              </div>
              <div>{{ item.title }}</div>
              <div class="muted">{{ t('items.idLabel') }}: {{ item.source_id }}</div>
              <a class="link" :href="item.item_url" target="_blank" rel="noopener">{{ t('items.view') }}</a>
            </div>
          </div>
        </div>
      </div>

      <div v-if="showAuth" class="modal-mask" @click.self="showAuth = false">
        <div class="modal">
          <div v-if="token">
            <div class="muted" style="margin-bottom:12px;">{{ t('auth.loggedIn') }}</div>
            <button class="btn-outline" @click="logout">{{ t('auth.logout') }}</button>
            <button class="btn-danger" style="margin-top:8px;" @click="deleteAccount">{{ t('auth.deleteAccount') }}</button>
          </div>
        </div>
      </div>

      <div v-if="confirmModal.show" class="modal-mask" @click.self="confirmCancel">
        <div class="modal confirm-modal">
          <h3 class="modal-title">{{ confirmModal.title }}</h3>
          <p class="modal-desc">{{ confirmModal.message }}</p>
          <div class="modal-actions">
            <button class="btn-outline" @click="confirmCancel">{{ t('confirm.cancel') }}</button>
            <button class="btn-danger" @click="confirmOk">{{ t('confirm.ok') }}</button>
          </div>
        </div>
      </div>

      <div v-if="toast.show" class="toast" :class="toast.type">{{ toast.message }}</div>
      <div v-if="notifyToast.show" class="notify-toast">
        <div class="notify-title">{{ t('items.notifyTitle') }}</div>
        <div class="notify-body">{{ notifyToast.message }}</div>
      </div>
    </div>

    <script src="assets/app.js?v=20260114a"></script>
  </body>
</html>
