services:
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-goodshunter_root}
      MYSQL_DATABASE: goodshunter
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - goodshunter-net

  redis:
    image: redis:7
    restart: always
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-goodshunter_redis}"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-goodshunter_redis}", "PING"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - goodshunter-net

  crawler:
    image: ghcr.io/${REPO_OWNER:-kahanat800}/goodshunter-crawler:latest
    restart: always
    stop_grace_period: 2m
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_LOG_LEVEL: ${APP_LOG_LEVEL:-info}
      APP_CRAWLER_GRPC_ADDR: ${APP_CRAWLER_GRPC_ADDR:-:50051}
      APP_RATE_LIMIT: ${APP_RATE_LIMIT:-3}
      APP_RATE_BURST: ${APP_RATE_BURST:-5}
      PROXY_COOLDOWN: ${PROXY_COOLDOWN:-10m}
      MAX_TASKS: ${MAX_TASKS:-500}
      FORCE_PROXY_ONCE: ${FORCE_PROXY_ONCE:-false}
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-goodshunter_redis}
      CRAWLER_METRICS_ADDR: ${CRAWLER_METRICS_ADDR:-:2112}
      CHROME_BIN: ${CHROME_BIN:-/usr/bin/chromium-browser}
      BROWSER_BIN_PATH: ${BROWSER_BIN_PATH:-/usr/bin/chromium-browser}
      HTTP_PROXY: ${HTTP_PROXY:-}
      BROWSER_HEADLESS: ${BROWSER_HEADLESS:-true}
      BROWSER_MAX_CONCURRENCY: ${BROWSER_MAX_CONCURRENCY:-5}
      BROWSER_MAX_FETCH_COUNT: ${BROWSER_MAX_FETCH_COUNT:-50}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 50051"]
      interval: 10s
      timeout: 3s
      retries: 5
    expose:
      - "2112"
    networks:
      - goodshunter-net

  api:
    image: ghcr.io/${REPO_OWNER:-kahanat800}/goodshunter-api:latest
    restart: always
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_LOG_LEVEL: ${APP_LOG_LEVEL:-info}
      APP_HTTP_ADDR: ${APP_HTTP_ADDR:-:8080}
      APP_CRAWLER_GRPC_ADDR: ${APP_CRAWLER_GRPC_ADDR:-crawler:50051}
      APP_SCHEDULE_INTERVAL: ${APP_SCHEDULE_INTERVAL:-5m}
      APP_NEW_ITEM_DURATION: ${APP_NEW_ITEM_DURATION:-1h}
      APP_MAX_TASKS_PER_USER: ${APP_MAX_TASKS_PER_USER:-3}
      APP_MAX_ITEMS_PER_TASK: ${APP_MAX_ITEMS_PER_TASK:-300}
      APP_WORKER_POOL_SIZE: ${APP_WORKER_POOL_SIZE:-50}
      APP_QUEUE_CAPACITY: ${APP_QUEUE_CAPACITY:-1000}
      APP_QUEUE_BATCH_SIZE: ${APP_QUEUE_BATCH_SIZE:-100}
      APP_DEDUP_WINDOW: ${APP_DEDUP_WINDOW:-3600}
      APP_RATE_LIMIT: ${APP_RATE_LIMIT:-3}
      APP_RATE_BURST: ${APP_RATE_BURST:-5}
      APP_GUEST_IDLE_TIMEOUT: ${APP_GUEST_IDLE_TIMEOUT:-10m}
      APP_GUEST_HEARTBEAT: ${APP_GUEST_HEARTBEAT:-5m}
      APP_ENABLE_REDIS_QUEUE: ${APP_ENABLE_REDIS_QUEUE:-false}
      APP_TASK_QUEUE_STREAM: ${APP_TASK_QUEUE_STREAM:-goodshunter:task:queue}
      APP_TASK_QUEUE_GROUP: ${APP_TASK_QUEUE_GROUP:-scheduler_group}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-goodshunter_root}
      DB_NAME: ${DB_NAME:-goodshunter}
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-goodshunter_redis}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      INVITE_CODE: ${INVITE_CODE:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      SMTP_TO: ${SMTP_TO:-}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      crawler:
        condition: service_healthy
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - goodshunter-net

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./web:/var/www/html:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    depends_on:
      - api
    networks:
      - goodshunter-net

  certbot:
    image: certbot/certbot
    restart: unless-stopped
    profiles: ["ssl"]  # 仅在需要 Let's Encrypt SSL 时启用
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  redis-exporter:
    image: oliver006/redis_exporter:latest
    restart: always
    profiles: ["monitoring-cloud"]  # Grafana Cloud 采集
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-goodshunter_redis}
    networks:
      - goodshunter-net
  
  mysql-exporter:
    image: prom/mysqld-exporter:v0.15.1  # 固定版本，避免 breaking changes
    restart: always
    profiles: ["monitoring-cloud"]  # Grafana Cloud 采集
    command:
      - '--mysqld.username=exporter'
      - '--mysqld.address=mysql:3306'
    environment:
      - MYSQLD_EXPORTER_PASSWORD=${MYSQL_EXPORTER_PASSWORD:-exporter_password_123}
    networks:
      - goodshunter-net

  # ============================================
  # Grafana Cloud Monitoring (轻量化)
  #
  # 使用 Grafana Alloy 采集指标/日志并推送到 Grafana Cloud
  # ============================================
  alloy:
    image: grafana/alloy:latest
    restart: always
    profiles: ["monitoring-cloud"]
    command:
      - run
      - /etc/alloy/config.river
    environment:
      - GRAFANA_CLOUD_PROM_REMOTE_WRITE_URL=${GRAFANA_CLOUD_PROM_REMOTE_WRITE_URL}
      - GRAFANA_CLOUD_PROM_USERNAME=${GRAFANA_CLOUD_PROM_USERNAME}
      - GRAFANA_CLOUD_PROM_API_KEY=${GRAFANA_CLOUD_PROM_API_KEY}
      - GRAFANA_CLOUD_LOKI_URL=${GRAFANA_CLOUD_LOKI_URL}
      - GRAFANA_CLOUD_LOKI_USERNAME=${GRAFANA_CLOUD_LOKI_USERNAME}
      - GRAFANA_CLOUD_LOKI_API_KEY=${GRAFANA_CLOUD_LOKI_API_KEY}
    volumes:
      - ./deploy/alloy/config.river:/etc/alloy/config.river:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro
    depends_on:
      - api
      - redis-exporter
      - mysql-exporter
      - cadvisor
      - node-exporter
    networks:
      - goodshunter-net

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    restart: always
    profiles: ["monitoring-cloud"]
    privileged: true
    devices:
      - /dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - goodshunter-net

  node-exporter:
    image: prom/node-exporter:v1.8.1
    restart: always
    profiles: ["monitoring-cloud"]
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/host/root'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro
    networks:
      - goodshunter-net

volumes:
  mysql_data:
  redis_data:

networks:
  goodshunter-net:
    driver: bridge
